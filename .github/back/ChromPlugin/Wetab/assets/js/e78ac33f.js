"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[7811],{17811:(t,e,n)=>{n.r(e),n.d(e,{NEWCHAT_ID:()=>m,useChatGptStore:()=>f});var s=n(10435),i=n(22140),a=n(74003),o=n(88287);var r=n(28850),c=n(80661),d=n(77363),h=n(60385),g=n(54348);const u=function(t){return function(e,n,s){var i=Object(e);if(!(0,h.Z)(e)){var a=(0,d.Z)(n,3);e=(0,g.Z)(e),n=function(t){return a(i[t],t,i)}}var o=t(e,n,s);return o>-1?i[a?e[o]:o]:void 0}};var v=n(30967);const l=u(v.Z),p=(0,i.useUserStore)(),m="newChat",L={name:"新的聊天",id:m,messages:[],updateTime:c().format("YYYY-MM-DD HH:mm")},f=(0,s.Q_)(r.BU.chatgpt,{syncStorage:{watch:["customLinks","panelType","linksList","chatTips","conversionList"]},syncCloud:{watch:["customLinks","panelType"]},state:()=>({modalShow:!1,linksList:[],selectedLink:null,panelType:"chatai",customLinks:[],conversionList:[L],activeConversionId:m,chatTips:"世界上有多少人口？",pending:!1,chatLoading:!1,pagination:{pageNo:0,loading:!1,finished:!1}}),getters:{conversionDataList(){return this.conversionList.map((t=>{var e,n;return{...t,name:(null===(e=t.messages[0])||void 0===e?void 0:e.content)||"新的聊天",updateTime:c(null===(n=t.messages[0])||void 0===n?void 0:n.updateTime).format("YYYY-MM-DD HH:mm")}}))},activeConversionItem(){const t=this.conversionList.find((t=>t.id===this.activeConversionId));return t||L},userOperationDisabled(){return!p.isLogin||this.pending||this.chatLoading}},actions:{setModal(t){this.modalShow=t},setPanelType(t){this.panelType=t},setSelectLink(t){this.selectedLink=t},addCustomLink(t){const e=[...this.customLinks];e.push(t),this.customLinks=e},removeCustomLink(t){const e=[...this.customLinks];e.splice(t,1),this.customLinks=e},setActiveConversionId(t){this.activeConversionId=t},async deleteConversionItem(t){this.conversionList=this.conversionList.filter((e=>e.id!==t)),t===this.activeConversionId&&(this.activeConversionId=this.conversionDataList[0].id);const[e,n]=await(async t=>{try{const e=await o.hj.post(`${a.kP}chat/delete`,{conversationId:t},{_auth:!0});if(0===e.code&&e.data)return[null,e.data];throw e}catch(t){return["catch error"]}})(t)},newChatHandler(){const t={name:"新的聊天",id:m,messages:[],updateTime:c().format("YYYY-MM-DD HH:mm")};this.conversionList=[t,...this.conversionList],this.activeConversionId=m},async reqGptLinks(){const[t,e]=await(async()=>{try{const t=await o.hj.get(`${a.kP}chat/list`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}})();!t&&e&&(this.linksList=e,this.selectedLink=e[0])},async reqConversionList(t){if(this.pagination.loading||this.pagination.finished)return;this.pagination={...this.pagination,loading:!0};const[e,n]=await(async(t,e)=>{try{const n=await o.hj.get(`${a.kP}chat/history`,{pageNo:t,pageSize:e},{_auth:!0});if(0===n.code&&n.data)return[null,n.data];throw n}catch(t){return["catch error"]}})(this.pagination.pageNo);if(!e&&n){var s;if(t)this.conversionList=[L,...n.list];else if(this.conversionList=[...this.conversionList,...n.list],this.activeConversionId===m)this.activeConversionId=(null===(s=n.list[0])||void 0===s?void 0:s.id)||m;n.totalPages-n.pageNo<=1?this.pagination={...this.pagination,finished:!0,loading:!1}:this.pagination={pageNo:n.pageNo+1,loading:!1,finished:!1}}},addUserMessage(t,e){const n=[...this.conversionList],s=n.find((t=>t.id===e));null==s||s.messages.push({role:"user",content:t,updateTime:c().valueOf()}),this.conversionList=n},onClickTryIt(){this.sendChatMessage(this.chatTips,m)},async reqChatTips(){const[t,e]=await(async()=>{try{const t=await o.hj.get(`${a.kP}chat/recommended`);if(0===t.code&&t.data)return[null,t.data];throw t}catch(t){return["catch error"]}})();!t&&e&&(this.chatTips=e)},updatePendingMessage(t){const e=[...this.conversionList],n=e.find((e=>e.id===t.conversionId)),s=n.messages.find((t=>t.loading));s&&(s.loading=!1,s.pending=!0),this.pending=!0;const i=n.messages.find((t=>t.pending));if(t.error)return i.error=!0,i.content=t.content,i.pending=!1,i.extra=t.showNewBtn,this.pending=!1,void(this.conversionList=e);t.done&&(i.pending=!1,t.conversionId===m&&t.id&&(n.id=t.id,this.activeConversionId=t.id),this.pending=!1),i.content+=t.content,this.conversionList=e},createLoadingMsg(t){const e=[...this.conversionList];e.find((e=>e.id===t)).messages.push({role:"assistant",content:"",loading:!0}),this.conversionList=e},async sendChatMessage(t,e){this.chatLoading=!0,this.addUserMessage(t,e),this.createLoadingMsg(e);const n=e===m?void 0:e,[s,i]=await(async(t,e)=>{try{return[null,await o.hj.post(`${a.kP}chat/conversation`,{prompt:t,conversationId:e},{_auth:!0,_stream:!0})]}catch(t){return["catch error"]}})(t,n);this.chatLoading=!1,!s&&i?this.streamReaderToText(i,e):this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0})},async streamReaderToText(t,e){const n=await t.read();if(n.done)return;const s=n.value;let i="";i=new TextDecoder("utf-8").decode(s);const a=i.split("_e79218965e_").filter((t=>!!t));this.handleChunksText(a,e),this.streamReaderToText(t,e)},deleteLastMessage(t,e){const n=[...this.conversionList],s=n.find((t=>t.id===e)),i=(0,v.Z)(s.messages,(e=>e.role===t));s.messages.splice(i,1),this.conversionList=n},async reGenerateLastAnwser(t){const e=[...this.conversionList].find((e=>e.id===t)),n=e.messages.find((t=>t.error));if(this.deleteLastMessage("assistant",t),n){const n=l(e.messages,(t=>"user"===t.role)).content;return this.deleteLastMessage("user",t),void this.sendChatMessage(n,t)}this.createLoadingMsg(t);const[s,i]=await(async t=>{try{return[null,await o.hj.post(`${a.kP}chat/regenerate`,{conversationId:t},{_auth:!0,_stream:!0})]}catch(t){return["catch error"]}})(t);!s&&i&&this.streamReaderToText(i,t)},handleChunksText(t,e){t.forEach((t=>{try{const n=JSON.parse(t);if(0===n.code)return void this.updatePendingMessage({conversionId:e,content:n.data});if(5001===n.code){const t=JSON.parse(n.data);return void this.updatePendingMessage({conversionId:e,content:"",id:t.conversationId,done:!0})}if(4002===n.code)return p.getProfile(),void this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0});if(5002===n.code||5003===n.code||1001===n.code)return void this.updatePendingMessage({conversionId:e,content:n.message||"系统错误",error:!0,done:!0});if(5004===n.code)return void this.updatePendingMessage({conversionId:e,content:n.message||"系统错误",error:!0,done:!0,showNewBtn:!0});this.updatePendingMessage({conversionId:e,content:n.message||"系统错误，请稍后重试",error:!0,done:!0})}catch(t){this.updatePendingMessage({conversionId:e,content:"系统错误，请重试",error:!0,done:!0})}}))}}})},30967:(t,e,n)=>{n.d(e,{Z:()=>c});var s=n(46146),i=n(77363),a=n(60275),o=Math.max,r=Math.min;const c=function(t,e,n){var c=null==t?0:t.length;if(!c)return-1;var d=c-1;return void 0!==n&&(d=(0,a.Z)(n),d=n<0?o(c+d,0):r(d,c-1)),(0,s.Z)(t,(0,i.Z)(e,3),d,!0)}}}]);