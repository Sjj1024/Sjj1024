"use strict";(globalThis.webpackChunkinfinity_hitab_client=globalThis.webpackChunkinfinity_hitab_client||[]).push([[1259],{73337:(t,e,i)=>{i.d(e,{Kn:()=>y,fN:()=>h,k$:()=>u,nI:()=>l});var a=i(74003),d=i(63477),r=i(80661),n=i.n(r),s=i(88287);const h=async t=>{try{const e=await s.hj.get(`${a.H}weather/city`,{location:t,lang:a.sM?"zh":"en"},{_delay:200,_single:!0});if(0===e.code&&e.data.list.length>0)return[null,e.data.list.map((t=>({...t,cid:t.id})))];throw e}catch(t){return["catch error"]}},c=t=>(t.updateTime=n()(t.updateTime).valueOf(),t.daily=t.daily.map((t=>{const e=(0,d.sG)(t.fxDate);return{...t,fxDateStr:a.sM?e.format("M月D ddd"):e.format("MMM D, ddd"),dateStr:e.format("ddd"),weekStr:a.sM?e.format("D日"):e.format("D"),tempMax:t.tempMax+"°",tempMin:t.tempMin+"°"}})),t),o=t=>(t.updateTime=n()(t.updateTime).valueOf(),t.hourly=t.hourly.map((t=>({...t,fxTimeStr:n()(t.fxTime).format("HH:mm"),temp:t.temp+"°",windScale:a.sM?t.windScale+"级":"级"+t.windScale,windSpeed:t.windSpeed+"km/h",humidity:t.humidity+"%",precip:t.precip+"mm"}))),t),l=async t=>{try{const e=await s.hj.get(`${a.H}weather/daily`,{location:t,lang:a.sM?"zh":"en"},{_delay:0});if(0===e.code)return[null,c(e.data)];throw e}catch(t){return["catch error"]}},y=async t=>{try{const e=await s.hj.get(`${a.H}weather/hourly`,{location:t,lang:a.sM?"zh":"en"},{_delay:0});if(0===e.code)return[null,o(e.data)];throw e}catch(t){return["catch error"]}},u=async()=>{try{const t=await s.hj.get(`${a.H}weather/location`,{},{_delay:0});if(0===t.code)return[null,t.data];throw t}catch(t){return["catch error"]}}},84138:(t,e,i)=>{i.d(e,{i7:()=>l,iE:()=>s,m_:()=>h,x4:()=>o,zI:()=>r});var a=i(74003),d=i(73337);const r="location",n={sunny:[[100],[150]],cloudy:[[101,104],[151,154]],rain:[[300,399]],snow:[[400,499]],haze:[[500,515]]};function s(t){const e=Number(t);let i="cloudy";for(const t in n){if(n[t].some((a=>{if(1===a.length){if(e===a[0])return i=t,!0}else if(2===a.length&&e>=a[0]&&e<=a[0])return i=t,!0})))break}return i}const h=t=>`${a.c1}/weather-icon/${t}.png`,c=a.sM?"116.40528,39.90498":"-73.96900,40.77899";function o(t){return new Promise((e=>{let i=!1;const a=t=>{i=!0,e(t)};setTimeout((()=>{i||(0,d.k$)().then((e=>{let[i,d]=e;a(null===i?d:t?"":c)}))}),0),setTimeout((()=>{a(t?"":c)}),5e3)}))}const l=(t,e)=>`weather-bg-${e||"cloudy"}-${t}`},41259:(t,e,i)=>{i.r(e),i.d(e,{useWeatherStore:()=>u,widgetInfo:()=>y});var a=i(28850),d=i(10435),r=i(84138),n=i(73337),s=i(34906),h=i(94119),c=i(24581),o=i(12793);const l={cityId:r.zI},y=(0,c.E0)(c.Rm.timerMark),u=(0,d.Q_)(a.BU.weather,{syncStorage:{watch:["weathers","locationCity","addedCity","activeCityId"]},syncCloud:{watch:["addedCity","activeCityId"]},state:()=>({searchModalShow:!1,modalShow:!1,weathers:{},locationCity:{cid:"",name:"",adm1:"",adm2:"",expired:0},addedCity:[],activeCityId:r.zI,activeWidgetId:"",widgetData:l}),getters:{allCids(){return this.addedCity.map((t=>t.cid)).concat(this.locationCity.cid)},activeCid(){return this.activeCityId===r.zI?this.locationCity.cid:this.activeCityId},getCityWeather:t=>e=>t.weathers[e],activeCityWeather(){return this.getCityWeather(this.activeCid)},activeNow(){var t;return null===(t=this.activeCityWeather)||void 0===t?void 0:t.now},activeDay(){var t;return null===(t=this.activeCityWeather)||void 0===t?void 0:t.day},activeHour(){var t;return null===(t=this.activeCityWeather)||void 0===t?void 0:t.hour},activeTempRange(){var t,e;const i=null===(t=this.activeCityWeather)||void 0===t||null===(e=t.day)||void 0===e?void 0:e.list;if(i){const t=i[0].tempMin;return`${i[0].tempMax} ~ ${t}`}return""},activeCity(){return this.activeCityId===r.zI?this.locationCity:this.addedCity.find((t=>t.cid===this.activeCityId))},addedCityIds(){return this.addedCity.map((t=>t.cid))},activeCityLongName(){return this.activeCity?this.activeCity.adm2===this.activeCity.name?this.activeCity.name:this.activeCity.adm2+" · "+this.activeCity.name:""}},actions:{saveWidgetData(t,e){const i=(0,o.i)(),a=i.getIconData(t);i.saveIcon({...a,id:t,widgetData:e})},getCity(t){return t==r.zI?this.locationCity:this.addedCity.find((e=>e.cid===t))||this.locationCity},getCityLongName(t){const e=this.getCity(t);return e?e.adm2===e.name?e.name:e.adm2+" · "+e.name:""},getWeather(t){const e=this.getCity(t).cid;return this.getCityWeather(e)},getTempRange(t){var e,i;const a=null===(e=this.getWeather(t))||void 0===e||null===(i=e.day)||void 0===i?void 0:i.list;if(a){const t=a[0].tempMin;return`${a[0].tempMax} ~ ${t}`}return""},async setSearchModal(t){this.searchModalShow=t,t&&(await this.reqLocation(!1),this.reqAllWeather())},async setModal(t,e){e&&(this.activeWidgetId=e),h.G.setStatus(c.Rm.weather,t),t?this.reqAllWeather():this.searchModalShow=!1,this.modalShow=t},setActive(t,e){this.activeCityId=t,t&&(e||this.activeWidgetId)&&(this.widgetData={cityId:t},this.saveWidgetData(e||(e||this.activeWidgetId),this.widgetData))},async reqHourWeather(t){const[e,i]=await(0,n.Kn)(t);if(e)return;const a={list:i.hourly,expired:(0,s.Z)(i.expiredTime,Date.now()+12e4,Date.now()+36e5),updateTime:i.updateTime},d=i.hourly[0],h={updateTime:i.updateTime,type:(0,r.iE)(d.icon),temp:d.temp,icon:d.icon,text:d.text,windDir:d.windDir,windScale:d.windScale,windSpeed:d.windSpeed,humidity:d.humidity,precip:d.precip,pressure:d.pressure};this.weathers[t]={...this.weathers[t],hour:a,now:h},this.weathers={...this.weathers}},clearWeathers(){Object.keys(this.weathers).forEach((t=>{this.allCids.includes(t)||delete this.weathers[t]}))},async reqDayWeather(t){const[e,i]=await(0,n.nI)(t);if(e)return;const a={list:i.daily,expired:(0,s.Z)(i.expiredTime,Date.now()+12e4,Date.now()+288e5),updateTime:i.updateTime};this.weathers[t]={...this.weathers[t],day:a},this.weathers={...this.weathers}},async reqWeather(t){var e;t===r.zI&&(t=null===(e=this.getCity(t))||void 0===e?void 0:e.cid);if(!t)return;const i=this.getCityWeather(t),a=[];i?((!i.day||i.day.expired<Date.now())&&a.push(this.reqDayWeather(t)),(!i.hour||i.hour.expired<Date.now())&&a.push(this.reqHourWeather(t))):a.push(this.reqDayWeather(t),this.reqHourWeather(t)),await Promise.all(a)},async reqAllWeather(){await Promise.all([this.reqWeather(this.locationCity.cid),...this.addedCity.map((t=>this.reqWeather(t.cid)))])},async reqLocation(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];try{if(!e){if(this.locationCity.expired>Date.now())return;if(t&&this.locationCity.cid)return}const i=await(0,r.x4)(!!this.locationCity.cid);if(!i)return;const[a,d]=await(0,n.fN)(i);if(a||!d)return;this.locationCity={cid:d[0].id,name:d[0].name,adm1:d[0].adm1,adm2:d[0].adm2,expired:Date.now()+2e3}}catch(t){}},async addCity(t){const e=this.addedCity.findIndex((e=>e.cid===t.cid));e>-1&&this.addedCity.splice(e,1),this.addedCity.unshift(t),this.addedCity.length>4&&(this.addedCity.length=4),this.addedCity=[...this.addedCity],await this.reqAllWeather(),this.clearWeathers()},removeCity(t){const e=this.addedCity.findIndex((e=>e.cid===t));e>-1&&(this.addedCity.splice(e,1),this.addedCity=[...this.addedCity]),this.clearWeathers()}}})}}]);